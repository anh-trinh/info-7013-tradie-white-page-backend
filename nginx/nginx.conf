server {
    listen 80;
    server_name localhost;

    # Healthcheck
    location = /healthz { return 200; }

    # Authn: validate token via Account Service
    location = /_auth_verify {
        internal;
        proxy_pass http://account-service:8000/api/accounts/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Authorization $http_authorization;
    }

    # Public endpoints (no token)
    location = /api/accounts/login { proxy_pass http://account-service:8000; }
    location = /api/accounts/register { proxy_pass http://account-service:8000; }
    location ^~ /api/tradies { proxy_pass http://tradie-service:8000; }
    location ^~ /api/services { proxy_pass http://tradie-service:8000; }
    location ^~ /api/reviews/tradie { proxy_pass http://review-service:8000; }

    # Protected APIs (require token)
    location ^~ /api/ {
        auth_request /_auth_verify;

        location ^~ /api/accounts/ { proxy_pass http://account-service:8000; }
        location ^~ /api/bookings/ { proxy_pass http://booking-service:80; }
        location ^~ /api/reviews/ { proxy_pass http://review-service:8000; }

        # Admin-only APIs
        location ^~ /api/admin/ {
            auth_request /_auth_verify;
            location ^~ /api/admin/accounts/ { proxy_pass http://account-service:8000; }
            location ^~ /api/admin/categories/ { proxy_pass http://tradie-service:8000; }
            location ^~ /api/admin/bookings/ { proxy_pass http://booking-service:80; }
            location ^~ /api/admin/reviews/ { proxy_pass http://review-service:8000; }
        }
    }
}
