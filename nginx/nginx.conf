# API Gateway for Tradie White Page

server {
    listen 80;
    server_name localhost;

    # DNS resolver so Nginx re-resolves Docker DNS for variable proxy_pass targets
    # Shorter cache time to avoid stale DNS issues in Docker
    resolver 127.0.0.11 valid=10s ipv6=off;
    resolver_timeout 2s;

    # --------- Global CORS (for SPA) ---------
    # Allow browser apps (e.g., Vite on 5173) to call APIs without upstream involvement for preflight
    add_header Access-Control-Allow-Origin $http_origin always;
    add_header Vary Origin always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With" always;
    add_header Access-Control-Allow-Credentials "false" always;

    # Short-circuit CORS preflight globally (avoids 502 if upstream doesn't handle OPTIONS)
    if ($request_method = OPTIONS) {
        return 204;
    }

    # Dynamic upstreams using variables (forces per-request DNS resolution)
    set $account_host account-service:8000;
    set $tradie_host  tradie-service:3000;
    set $booking_host booking-service:80;
    set $review_host  review-service:8000;

    # Healthcheck
    location = /healthz { return 200; }

    # Authn: validate token via Account Service
    location = /_auth_verify {
        internal;
        proxy_pass http://$account_host/api/accounts/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Authorization $http_authorization;
    }

    # ---------- Public endpoints ----------
    # Login & Register
    location = /api/accounts/login {
        proxy_pass http://$account_host;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
    }
    location = /api/accounts/register {
        proxy_pass http://$account_host;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
    }

    # Exact-match protected route MUST precede the public /api/tradies prefix
    location = /api/tradies/profile {
        auth_request /_auth_verify;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_pass http://$tradie_host;
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-User-Role $user_role;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
    }

    # Public Tradies + Services browsing
    location ^~ /api/tradies {
        proxy_pass http://$tradie_host;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
    }
    location ^~ /api/services {
        proxy_pass http://$tradie_host;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
    }

    # Reviews (public for tradie details page)
    location ^~ /api/reviews/tradie {
        proxy_pass http://$review_host;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
    }

    # ---------- Protected API prefixes ----------
    # Accounts (me/update etc.)
    location ^~ /api/accounts {
        auth_request /_auth_verify;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_pass http://$account_host;
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-User-Role $user_role;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
    }

    # Internal account lookups for S2S
    location ^~ /api/internal/accounts {
        auth_request /_auth_verify;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_pass http://$account_host;
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-User-Role $user_role;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
    }

    # Bookings & Quotes
    location ^~ /api/bookings {
        auth_request /_auth_verify;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_pass http://$booking_host;
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-User-Role $user_role;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
    }
    location ^~ /api/quotes {
        auth_request /_auth_verify;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_pass http://$booking_host;
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-User-Role $user_role;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
    }

    # Protected reviews subset
    location ^~ /api/reviews {
        auth_request /_auth_verify;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_pass http://$review_host;
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-User-Role $user_role;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
    }

    # Admin prefixes
    location ^~ /api/admin/accounts {
        auth_request /_auth_verify;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_pass http://$account_host;
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-User-Role $user_role;
    }
    location ^~ /api/admin/categories {
        auth_request /_auth_verify;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_pass http://$tradie_host;
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-User-Role $user_role;
    }
    location ^~ /api/admin/bookings {
        auth_request /_auth_verify;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_pass http://$booking_host;
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-User-Role $user_role;
    }
    location ^~ /api/admin/reviews {
        auth_request /_auth_verify;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_pass http://$review_host;
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-User-Role $user_role;
    }

    # ---------- Frontend routing ----------
    # MPA pages (served by port 8000, fallback to static HTML)
    # MPA pages: match exact /tradie or /tradie/... but NOT /tradie-dashboard
    location ~ ^/(search|login|register|admin/login|$|tradie(?:/|$)) {
        proxy_pass http://host.docker.internal:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 2s;
        proxy_read_timeout 5s;
        
        # Fallback to static HTML if MPA service is not available
        error_page 502 503 504 = @mpa_fallback;
    }

    # SPA pages + all Vite dev assets (served by port 5173, fallback to static HTML)
    # - Matches: /dashboard, /tradie-dashboard, /admin and any children
    # - Also matches Vite client + transformed module paths: /@vite, /@id, /@fs, /src, /node_modules
    location ^~ /tradie-dashboard {
        proxy_pass http://host.docker.internal:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 2s;
        proxy_read_timeout 5s;
        error_page 502 503 504 = @spa_fallback;
    }
    location ~ ^/(dashboard(?:/|$)|admin(?:/|$)|@vite|@id|@fs|src/|node_modules/) {
        proxy_pass http://host.docker.internal:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 2s;
        proxy_read_timeout 5s;
        
        # Fallback to static HTML if SPA service is not available
        error_page 502 503 504 = @spa_fallback;
    }

    # Default: MPA fallback
    location / {
        proxy_pass http://host.docker.internal:8000;
        proxy_set_header Host $host;
        proxy_connect_timeout 2s;
        proxy_read_timeout 5s;
        
        # Fallback to static HTML if MPA service is not available
        error_page 502 503 504 = @mpa_fallback;
    }

    # MPA Fallback location
    location @mpa_fallback {
        return 200 '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tradie White Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">MPA Frontend service not running on port 8000. Start with: <code class="bg-yellow-100 px-1 rounded">php -S 0.0.0.0:8000 -t public</code></p>
                </div>
            </div>
        </div>
        
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Tradie White Page Backend</h1>
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">API Endpoints Available:</h2>
            <ul class="space-y-2">
                <li><a href="/api/tradies" class="text-blue-600 hover:underline">/api/tradies</a> - List all tradies</li>
                <li><a href="/api/tradies/1" class="text-blue-600 hover:underline">/api/tradies/1</a> - Get specific tradie</li>
                <li><a href="/api/services" class="text-blue-600 hover:underline">/api/services</a> - List all services</li>
                <li><a href="/api/reviews/tradie/1" class="text-blue-600 hover:underline">/api/reviews/tradie/1</a> - Get reviews for tradie</li>
            </ul>
            <p class="mt-4 text-gray-600">Backend services are running properly with contact information for all tradies!</p>
        </div>
    </div>
</body>
</html>';
        add_header Content-Type text/html;
    }

    # SPA Fallback location
    location @spa_fallback {
        return 200 '<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPA Dashboard - Tradie White Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-50 font-sans">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-blue-100 border-l-4 border-blue-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-blue-700">SPA Frontend service not running on port 5173. Start with: <code class="bg-blue-100 px-1 rounded">npm run dev</code></p>
                </div>
            </div>
        </div>
        
        <h1 class="text-3xl font-bold text-blue-800 mb-6">SPA Dashboard</h1>
        <div class="bg-white rounded-lg shadow-md p-6">
            <p class="text-gray-600">Frontend SPA would be served here when running on port 5173.</p>
            <div class="mt-4">
                <h3 class="font-semibold mb-2">Backend APIs still work:</h3>
                <ul class="space-y-1 text-sm">
                    <li><a href="/api/tradies" class="text-blue-600 hover:underline">/api/tradies</a></li>
                    <li><a href="/api/services" class="text-blue-600 hover:underline">/api/services</a></li>
                    <li><a href="/api/reviews/tradie/1" class="text-blue-600 hover:underline">/api/reviews/tradie/1</a></li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>';
        add_header Content-Type text/html;
    }
}
