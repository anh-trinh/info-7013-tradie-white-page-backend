server {
    listen 80;
    server_name localhost;

    # Internal services on Railway (use service names)
    set $account_upstream account-service:8000;   # PHP built-in server
    set $booking_upstream booking-service:80;     # PHP built-in server
    set $review_upstream review-service:8000;     # FastAPI default
    set $tradie_upstream tradie-service:8000;     # PHP built-in server

    # Authn: validate token via Account Service
    location = /_auth_verify {
        internal;
        proxy_pass http://$account_upstream/api/accounts/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Authorization $http_authorization;
    }

    # Public endpoints (no token)
    location = /api/accounts/login { proxy_pass http://$account_upstream; }
    location = /api/accounts/register { proxy_pass http://$account_upstream; }
    location ^~ /api/tradies { proxy_pass http://$tradie_upstream; }
    location ^~ /api/services { proxy_pass http://$tradie_upstream; }
    location ^~ /api/reviews/tradie { proxy_pass http://$review_upstream; }

    # Protected APIs (require token)
    location ^~ /api/ {
        auth_request /_auth_verify;

        location ^~ /api/accounts/ { proxy_pass http://$account_upstream; }
        location ^~ /api/bookings/ { proxy_pass http://$booking_upstream; }
        location ^~ /api/reviews/ { proxy_pass http://$review_upstream; }

        # Admin-only APIs (additional check)
        location ^~ /api/admin/ {
            auth_request /_auth_verify; # validate again; admin check handled by service endpoint /validate-admin if used

            location ^~ /api/admin/accounts/ { proxy_pass http://$account_upstream; }
            location ^~ /api/admin/categories/ { proxy_pass http://$tradie_upstream; }
            location ^~ /api/admin/bookings/ { proxy_pass http://$booking_upstream; }
            location ^~ /api/admin/reviews/ { proxy_pass http://$review_upstream; }
        }
    }
}
